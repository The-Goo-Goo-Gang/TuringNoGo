# 程序设计大作业第二阶段报告
撰写人：梅祎航，杜非原
#### 小组分工

* 梅祎航：负责逻辑和网络主体代码的的设计与编写，测试代码，撰写实验报告。

* 杜非原：实现了小部分网络代码的编写，测试代码，撰写实验报告。

* 胡宇：代码测试。

* #### 代码框架

    * 我们的第二阶段，我们的ui分为四个部分，主界面，单机界面，联机界面，导入对局界面

 * *主界面*
    * 新增联机模式，导入对局选项

 * *单机界面*
   
    * 新增三种棋盘选择 9X9，11X11，13X13。
    
    * 下棋时实现当步棋子高亮，外框变红。
    
    * 在当步棋子落子时，分别在用户名上方显示落子颜色和顺序。
    
    * 在一方即将输掉时弹出提示，禁止下子，败方应及时认输作为游戏结束的标志。
    
    * 游戏结束后，此处以一方认输记，弹出选择框，打印两方落子点坐标及平均思考时间实现复盘对局，可选择是否保存对局，若保存则对局以txt文件格式保存两方棋子坐标。
    
 * *联机界面（本次重点）*
   
    * 实现方法，引入封装的3个网络库实现联机。
    
   * 棋盘继承自原有单机模式，一些其余功能与单机模式相同。
   
   * 网络功能的实现得益于两个函数receiveData()（服务端功能，接受客户端指令）和receiveDataFromServer()（客户端功能，接受服务端指令）具体功能如下：
       * 在棋盘左侧添加了聊天框，添加了聊天功能（实现方法：使用Chat_op套接字）
   
       * 左上角为连接界面，服务端输入客户端IPV4网址进行连接，客户端点击接受邀请使己方可以被连接，服务端发起邀请后客户端可选择是否接受，如接受，game_state置为1，游戏开始。拒绝则返回REJECT-OP直接结束
   
       * 邀请之前，双方均可修改自己的用户名及希望执黑/执白，若两方冲突，以服务端的要求为先，客户端自动置于服务端的相反颜色。（或许也可以聊天交流hhh）
   
       * 开始后，轮流发送MOVE_OP（包含落子点坐标），并显示在双方棋盘上。为了编程方便，我们有两个下棋函数，第一个是```get_btn_sign(int idx)```，其作用为我方下棋后，发送MOVE_OP并绘制棋子。第二个是```get_online_sign(int idx)```，其作用为接收MOVE_OP后，调用该函数。
           两函数都调用judge()函数判断胜负情况，每下一子重置思考时间。
   
       * 输掉比赛的方法有四种
   
       * 自己认输：“认输方通过认输按钮，调用```on_btn_lose_clicked()```发送GIVEUP_END_OP给胜者，胜者打出GG_OP，败者回复GG_OP确认,结束游戏。
   
       * 一方超时：在思考时间结束后仍未落子，```OnTimerCountdown()```(倒计时函数)发送TIMEOUT_END_OP，直接结束游戏，超时者失败。                    
   
       * 一方跑路：对战双方其中一方退出了比赛界面发送LEAVE_OP，退出者失败，结束游戏。
   
       * 非法落子：自杀或杀掉对方，即在游戏规则下的失败，我们禁止非法落子，所以非法落子者应在看到提示后主动认输。（这块有待斟酌）
   
    * 日志功能：本组利用了Qt自带的Qdebug，将Qdebug的输出打印到log文件中。
   
 * *导入界面*
   
    * 点击主界面上的”导入对局“按钮会使用导入对局功能，读入一个标准格式的txt文件，棋盘上会出现最后一步结束时棋子的布局。
      *注：此功能仅用于复盘，不支持继续在导入界面继续下棋。*
    
* 遇到的问题
  
  * 组内某废物的qt的debug功能寄了，导致无法调试代码，对其造成了极大的困扰。
  
  * 废物思想僵化，最开始只知道复制粘贴，导致150行多报错的产生。
  
  * 联机时两个端的计时不一致（后来知道是本地时间问题）



* 特别鸣谢
  * 感谢梅的神兵天降，在一天搞出了废物5天没搞出的联机部分。
  * 助教gg的耐心指导，让我们如沐神恩。
  * 感谢教二2220教室，提供了组内交流的地点